image: tico/docker

stages:
  - build
  - deploy

.up: &up
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY

.tags: &tags
  tags:
    - docker

build-production:
  stage: build
  only:
    - master
  services:
    - docker:dind
  <<: *up
  script:
    - if [ "$BUILD_PRODUCTION" != "true" ]; then exit 0; fi
    #- docker build -f web.production.Dockerfile --build-arg DATABASE_URL=$PRODUCTION_DATABASE_URL --build-arg SECRET_KEY_BASE=$SECRET_KEY_BASE .
    - docker build -f web.production.Dockerfile -t $CI_REGISTRY_IMAGE --build-arg DATABASE_URL=$PRODUCTION_DATABASE_URL --build-arg SECRET_KEY_BASE=$SECRET_KEY_BASE .
    - docker push $CI_REGISTRY_IMAGE
  <<: *tags

build-staging:
  stage: build
  only:
    - staging
  services:
    - docker:dind
  <<: *up
  script:
    - if [ "$BUILD_STAGING" != "true" ]; then exit 0; fi
    #- docker build -f web.staging.Dockerfile --build-arg DATABASE_URL=$STAGING_DATABASE_URL --build-arg SECRET_KEY_BASE=$SECRET_KEY_BASE .
    - docker build -f web.staging.Dockerfile -t $CI_REGISTRY_IMAGE --build-arg DATABASE_URL=$STAGING_DATABASE_URL --build-arg SECRET_KEY_BASE=$SECRET_KEY_BASE .
    - docker push $CI_REGISTRY_IMAGE
  <<: *tags

deploy_production:
  stage: deploy
  only:
    - master
  variables:
    TARGET_BRANCH: master
    TARGET_HOST: ubuntu@13.229.109.27
    TARGET_PATH: /var/app/production_app
  environment:
    name: production
    url: https://docker.obook.co
  script:
    - cibu prepare-ssh
    - cibu compose login gitlab-ci-token $CI_JOB_TOKEN $CI_REGISTRY
    - ssh $TARGET_HOST cd $TARGET_PATH; rm -rf docker
    - ssh $TARGET_HOST cd $TARGET_PATH; mkdir docker
    - scp -r /builds/$CI_PROJECT_PATH/docker-compose.production.yml $TARGET_HOST:/var/app/production_app
    - scp -r /builds/$CI_PROJECT_PATH/docker/* $TARGET_HOST:/var/app/production_app/docker
    - cibu compose pull
    - cibu compose update web
    - cibu compose up -d
    - cibu compose cleanup
  <<: *tags

deploy_staging:
  stage: deploy
  only:
    - staging
  variables:
    TARGET_BRANCH: staging
    TARGET_HOST: ubuntu@13.229.109.27
    TARGET_PATH: /var/app/staging_app
  environment:
    name: staging
    url: https://beta.obook.co
  script:
    - cibu prepare-ssh
    - cibu compose login gitlab-ci-token $CI_JOB_TOKEN $CI_REGISTRY
    - scp -r /builds/$CI_PROJECT_PATH/docker-compose.staging.yml $TARGET_HOST:/var/app/staging_app
    - cibu compose pull
    - cibu compose update web
    - cibu compose up -d
    - cibu compose cleanup
  <<: *tags
